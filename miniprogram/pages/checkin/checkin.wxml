<!--
  æ‰“å¡é¡µ - å¾®ä¿¡å°ç¨‹åºç‰ˆæœ¬
  å¯¹åº” React ç‰ˆæœ¬çš„ src/pages/Checkin.jsx
-->
<view class="page">
  <view class="page-title">æ‰“å¡ä¸­å¿ƒ</view>
  <view class="page-subtitle">é€‰æ‹©ä»»åŠ¡å¹¶å®Œæˆä»Šæ—¥æ‰“å¡ã€‚</view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- ä»»åŠ¡åˆ—è¡¨ -->
  <view class="list" wx:if="{{!loading}}">
    <block wx:for="{{tasks}}" wx:key="id">
      <!-- è¿åŠ¨ç±»ä»»åŠ¡ï¼šä½¿ç”¨åˆ†ç±»æ‰“å¡ç»„ä»¶ -->
      <view class="exercise-checkin" wx:if="{{item.name === 'è¿åŠ¨' && !exerciseCategoryHidden}}">
        <view class="exercise-header">
          <text class="exercise-icon">ğŸƒ</text>
          <text class="exercise-title">è¿åŠ¨</text>
        </view>

        <!-- å·²æ‰“å¡çŠ¶æ€ -->
        <view wx:if="{{isTaskChecked(item.id)}}" class="muted">ä»Šæ—¥å·²å®Œæˆ</view>

        <!-- æœªæ‰“å¡çŠ¶æ€ -->
        <block wx:else>
          <view class="exercise-hint">ç‚¹å‡»é€‰æ‹©è¿åŠ¨ç±»å‹å’Œæ—¶é•¿</view>

          <!-- è¿åŠ¨ç±»å‹æ ‡ç­¾ -->
          <view class="exercise-tags">
            <view
              wx:for="{{exerciseTags}}"
              wx:for-item="tag"
              wx:key="*this"
              class="exercise-tag {{selectedExerciseTag === tag ? 'active' : ''}}"
              bindtap="onSelectExerciseTag"
              data-tag="{{tag}}"
              data-task-id="{{item.id}}"
            >{{tag}}</view>
            <view class="exercise-tag add" bindtap="showAddTagModal">+ æ·»åŠ </view>
          </view>

          <!-- æ—¶é•¿é€‰æ‹©ï¼ˆé€‰ä¸­æ ‡ç­¾åæ˜¾ç¤ºï¼‰ -->
          <view class="duration-section" wx:if="{{selectedExerciseTag && selectedTaskId === item.id}}">
            <view class="duration-label">â”€â”€ é€‰æ‹©æ—¶é•¿ â”€â”€</view>
            <view class="duration-tags">
              <view
                wx:for="{{durationOptions}}"
                wx:for-item="duration"
                wx:key="*this"
                class="duration-tag"
                bindtap="onSelectDuration"
                data-duration="{{duration}}"
                data-task-id="{{item.id}}"
              >{{duration}}åˆ†é’Ÿ</view>
            </view>
          </view>

          <!-- å·²é€‰æ‹©åˆ—è¡¨ -->
          <view class="selected-section" wx:if="{{selectedExerciseItems.length > 0 && selectedTaskId === item.id}}">
            <view class="selected-label">â”€â”€ å·²é€‰æ‹© â”€â”€</view>
            <view class="selected-exercises">
              <view class="selected-item" wx:for="{{selectedExerciseItems}}" wx:for-item="sel" wx:key="index">
                <view class="selected-item-info">
                  <text class="selected-item-check">âœ“</text>
                  <text>{{sel.tag}} {{sel.measure}}åˆ†é’Ÿ</text>
                </view>
                <view class="selected-item-delete" bindtap="removeSelectedItem" data-index="{{index}}">Ã—</view>
              </view>
            </view>
          </view>

          <!-- æäº¤æŒ‰é’® -->
          <view class="exercise-submit" wx:if="{{selectedExerciseItems.length > 0 && selectedTaskId === item.id}}">
            <button
              class="exercise-submit-btn {{submitting ? 'disabled' : ''}}"
              bindtap="submitExerciseCheckin"
              data-task-id="{{item.id}}"
              disabled="{{submitting}}"
            >{{submitting ? 'æäº¤ä¸­...' : 'å®Œæˆæ‰“å¡ (' + totalExerciseMinutes + 'åˆ†é’Ÿ)'}}</button>
          </view>
        </block>
      </view>

      <!-- æ™®é€šä»»åŠ¡ -->
      <view class="list-item" wx:elif="{{item.name !== 'è¿åŠ¨'}}">
        <view class="list-item-content">
          <view class="list-item-title">{{item.name}}</view>
          <view class="muted">{{checkedTaskIds[item.id] ? 'ä»Šæ—¥å·²å®Œæˆ' : (item.description || 'ä»Šæ—¥ç›®æ ‡')}}</view>
        </view>
        <button
          class="btn {{checkedTaskIds[item.id] ? 'btn-primary' : 'btn-secondary'}}"
          bindtap="handleCheckin"
          data-task-id="{{item.id}}"
          disabled="{{checkedTaskIds[item.id] || checking === item.id}}"
        >{{checking === item.id ? 'æ‰“å¡ä¸­...' : (checkedTaskIds[item.id] ? 'å·²æ‰“å¡ âœ“' : 'ç«‹å³æ‰“å¡')}}</button>
      </view>
    </block>

    <!-- æ— ä»»åŠ¡æç¤º -->
    <view class="empty" wx:if="{{tasks.length === 0}}">æš‚æ— ä»»åŠ¡</view>
  </view>

  <!-- åˆ†ç±»ç®¡ç†åŒºåŸŸ -->
  <view class="category-manage-section" wx:if="{{!loading}}">
    <view class="category-manage-title">
      <text>âš™ï¸</text>
      <text>åˆ†ç±»ç®¡ç†</text>
    </view>
    <view class="category-manage-list">
      <!-- è¿åŠ¨åˆ†ç±» -->
      <view class="category-manage-item" bindtap="manageExerciseCategory">
        <text class="category-manage-item-icon">ğŸƒ</text>
        <text class="category-manage-item-name">è¿åŠ¨</text>
      </view>
    </view>
    <view class="add-category-btn" bindtap="showAddCategoryModal">
      <view class="add-category-icon">+</view>
      <text>æ·»åŠ æ–°åˆ†ç±»</text>
    </view>
  </view>

  <!-- æ·»åŠ æ ‡ç­¾å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showTagModal}}" bindtap="hideAddTagModal">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-title">æ·»åŠ è‡ªå®šä¹‰è¿åŠ¨ç±»å‹</view>
      <input
        class="input"
        placeholder="è¾“å…¥ç±»å‹åç§°"
        value="{{newTagValue}}"
        bindinput="onNewTagInput"
        maxlength="10"
      />
      <view class="modal-actions">
        <button class="btn btn-secondary" bindtap="hideAddTagModal">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="addCustomTag">ç¡®å®š</button>
      </view>
    </view>
  </view>
</view>
